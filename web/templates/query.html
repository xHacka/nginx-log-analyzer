{{define "title"}}Query Logs - Nginx Log Analyzer{{end}}
{{define "head"}}{{end}}

{{define "content"}}
<div class="query-page">
<details class="box filter-panel" open>
  <summary>Filters</summary>
  <form method="get" action="/query">
    <div class="columns">
      <div class="column is-half">
        <fieldset>
          <legend class="label">General</legend>
          <div class="field">
            <label class="label is-small" for="f-from">From</label>
            <div class="control">
              <input class="input is-small" type="datetime-local" id="f-from" name="time_from" value="{{.Filters.TimeFrom}}">
            </div>
          </div>
          <div class="field">
            <label class="label is-small" for="f-to">To</label>
            <div class="control">
              <input class="input is-small" type="datetime-local" id="f-to" name="time_to" value="{{.Filters.TimeTo}}">
            </div>
          </div>
          <div class="field">
            <label class="label is-small" for="f-country">Country Code</label>
            <div class="control">
              <input class="input is-small" type="text" id="f-country" name="country" placeholder="US, DE, ..." value="{{.Filters.Country}}">
            </div>
          </div>
          <div class="field">
            <label class="label is-small" for="f-ua">User-Agent</label>
            <div class="control">
              <input class="input is-small" type="text" id="f-ua" name="user_agent" placeholder="curl, Mozilla, ..." value="{{.Filters.UserAgent}}">
            </div>
          </div>
        </fieldset>
      </div>

      <div class="column is-half">
        <fieldset>
          <legend class="label">Request</legend>
          <div class="field">
            <label class="label is-small" for="f-method">Method</label>
            <div class="control">
              <div class="select is-small is-fullwidth">
                <select id="f-method" name="method">
                  <option value="">Any</option>
                  <option value="GET"{{if eq .Filters.Method "GET"}} selected{{end}}>GET</option>
                  <option value="POST"{{if eq .Filters.Method "POST"}} selected{{end}}>POST</option>
                  <option value="PUT"{{if eq .Filters.Method "PUT"}} selected{{end}}>PUT</option>
                  <option value="DELETE"{{if eq .Filters.Method "DELETE"}} selected{{end}}>DELETE</option>
                  <option value="PATCH"{{if eq .Filters.Method "PATCH"}} selected{{end}}>PATCH</option>
                  <option value="HEAD"{{if eq .Filters.Method "HEAD"}} selected{{end}}>HEAD</option>
                  <option value="OPTIONS"{{if eq .Filters.Method "OPTIONS"}} selected{{end}}>OPTIONS</option>
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label is-small" for="f-status">Status</label>
            <div class="control">
              <input class="input is-small" type="text" id="f-status" name="status" placeholder="200,203 or -404,-500" value="{{.Filters.Status}}">
            </div>
          </div>
          <div class="field">
            <label class="label is-small" for="f-path">Path</label>
            <div class="control">
              <input class="input is-small" type="text" id="f-path" name="path" placeholder="/api/..." value="{{.Filters.PathContains}}">
            </div>
          </div>
          <div class="field">
            <label class="label is-small" for="f-host">Host</label>
            <div class="control">
              <input class="input is-small" type="text" id="f-host" name="host" placeholder="example.com" value="{{.Filters.Host}}">
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <div class="field is-grouped mt-3">
      <div class="control">
        <button class="button is-primary is-small" type="submit">Apply Filters</button>
      </div>
      <div class="control">
        <a href="/query" class="button is-light is-small">Clear All</a>
      </div>
    </div>
  </form>
</details>

<div class="level mb-4">
  <div class="level-left">
    <div class="level-item">
      <p class="is-size-7 has-text-grey">{{.Total}} results &middot; page {{.Page}} of {{.Pages}}</p>
    </div>
  </div>
  <div class="level-right">
    <div class="level-item">
      <p class="is-size-7 has-text-grey mr-3">Showing {{len .Entries}} entries</p>
    </div>
    <div class="level-item">
      <div class="field has-addons">
        {{range .PageSizes}}
        <p class="control">
          <a class="button is-small{{if .Active}} is-primary{{end}}" href="{{.URL}}">{{.Size}}</a>
        </p>
        {{end}}
      </div>
    </div>
  </div>
</div>

<div class="table-container">
  <table class="table is-fullwidth is-striped is-hoverable log-table">
    <thead>
      <tr>
        {{range .Columns}}
        <th>
          <a href="{{.URL}}" class="has-text-dark" style="text-decoration:none">
            {{.Name}}
            {{if .Active}}
              {{if .Desc}}&darr;{{else}}&uarr;{{end}}
            {{end}}
          </a>
        </th>
        {{end}}
      </tr>
    </thead>
    <tbody>
      {{range .Entries}}
      <tr>
        <td>{{formatTime .Time}}</td>
        <td>{{.RemoteAddr}}</td>
        <td>{{.Host}}</td>
        <td><span class="method-tag">{{.Method}}</span></td>
        <td><code>{{.Path}}</code></td>
        <td><code>{{.Query}}</code></td>
        <td>{{.Protocol}}</td>
        <td><span class="tag status-badge {{statusClass .Status}}">{{.Status}}</span></td>
        <td>{{.Bytes}}</td>
        <td>{{.City}}</td>
        <td>{{.Country}}</td>
        <td class="ua-cell" title="{{.UserAgent}}">{{.UserAgent}}</td>
      </tr>
      {{end}}
    </tbody>
  </table>
</div>

<nav class="pagination is-centered is-small mt-5" role="navigation" aria-label="pagination">
  <ul class="pagination-list">
    <li>
      {{if .PrevURL}}<a class="pagination-link" href="{{.PrevURL}}">&laquo; Prev</a>
      {{else}}<span class="pagination-link" disabled>&laquo; Prev</span>{{end}}
    </li>
    <li><span class="pagination-link is-current">{{.Page}} / {{.Pages}}</span></li>
    <li>
      {{if .NextURL}}<a class="pagination-link" href="{{.NextURL}}">Next &raquo;</a>
      {{else}}<span class="pagination-link" disabled>Next &raquo;</span>{{end}}
    </li>
  </ul>
</nav>
</div>
{{end}}
